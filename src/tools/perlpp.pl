#
# PerlPP (PPP): Perl preprocessor
#
# http://darkness.codefu.org/wordpress/2003/03/perl-scoping/

package PerlPP;

use strict;
use warnings;
#use Data::Dumper;

my $TAG_OPEN = "<[?]";
my $TAG_CLOSE = "[?]>";

my $filename = "";
my $outFilename = "";
my $package = "";
my $commentsType = "";
my $echoMode = 0;		# contrary to an eval mode
my $code = "";
my $plain = "";
my $f;
my $PerlPP_out;

sub OutputPlain {
	$code .= "print \$PerlPP_out '" . ( $plain =~ s/\\/\\\\/gr ) =~ s/'/\\'/gr . "';\n";
	$plain = "";
}

sub OutputComments {
	my $prefix = "";

	if ( $commentsType eq "doubleslash" ) {
		$prefix = "//";
	} elsif ( $commentsType eq "hash" ) {
		$prefix = "#";
	} else {
		print "Unknown type of comments style.\n";
		return;
	}

	print $PerlPP_out "${prefix} This file is automatically generated by perlpp.pl\n";
	print $PerlPP_out "${prefix}   source: $filename\n";
	print $PerlPP_out "${prefix}   package: $package\n\n";
}

( $filename = shift ) and ( $outFilename = shift ) or die "Usage: perl perlpp.pl <inFilename> <outFilename>\n";

$package = ( $filename =~ s/^([a-zA-Z_][a-zA-Z_0-9.]*).p$/$1/r );
$package =~ s/\./_/g;
$commentsType = ( shift ) || "";

open $f, $filename or die $!;

OPENING:
while ( <$f> ) {
	if ( /^(.*?)$TAG_OPEN(.*)$/ ) {
		my $after = $2;
		my $inside = "";

		$plain .= $1;
		&OutputPlain;

		if ( $after =~ /^=/ ) {
			$echoMode = 1;
			$_ = substr( $after, 1 ) . "\n";
		} else {
			$_ = $after . "\n";
		}
		
		CLOSING:
		if ( /^(.*?)$TAG_CLOSE(.*)$/ ) {
			$inside .= $1;
			if ( $echoMode ) {
				$code .= "print \$PerlPP_out ( ${inside} );\n";
				$echoMode = 0;
			} else {
				$code .= $inside;
			}
			$_ = $2 . "\n";
			redo OPENING;
		} else {
			$inside .= $_ . "\n";
			$_ = <$f>;
			goto CLOSING;
		};
	} else {
		$plain .= $_;
	}
}
&OutputPlain;

close $f or die $!;

open $PerlPP_out, ">", "${outFilename}" or die $!;
&OutputComments;
eval( "package PPP_${package}; use strict; use warnings; sub echo { print \$PerlPP_out shift; }\n" . $code );
warn $@ if $@;
close $PerlPP_out or die $!;
